####################################
# Presence Binary Sensors
####################################
- platform: template
  sensors:
    shower_occupied:
      friendly_name: "Shower Occupied"
      device_class: occupancy
      value_template: >-
        {{ (states('sensor.bathroom_multisensor_humidity')| float > (states('sensor.bathroom_humidity_statistics')| float + states('input_number.bathroom_humidity_offset')| float)) and states(binary_sensor.bathroom_humidity_trend) }}

####################################
# People Home Binary Sensors
####################################
- platform: template
  sensors:
    people_home:
      friendly_name: "People Home"
      icon_template: "mdi:home"
      device_class: presence
      value_template: >-
        {{ is_state('person.laura_ward', 'home') or is_state('person.sebastian_burrell', 'home') }}

####################################
# Sleeping Binary Sensors
####################################
- platform: template
  sensors:
    laura_sleeping:
      friendly_name: "Laura Sleeping"
      icon_template: "mdi:sleep"
      value_template: "{{ states('sensor.laura_phone_sleep_confidence') | int > 90 }}"
    seb_sleeping:
      friendly_name: "Seb Sleeping"
      icon_template: "mdi:sleep"
      value_template: "{{ states('sensor.seb_phone_sleep_confidence') | int > 90 }}"

####################################
# Bayesian Sensors
####################################
# Bathroom
- platform: bayesian
  name: "Bathroom Occupied"
  prior: 0.1
  probability_threshold: 0.4
  observations:
    - platform: "state"
      entity_id: "binary_sensor.shower_occupied"
      prob_given_true: 0.29
      prob_given_false: 0.023
      to_state: "on"
    - platform: "state"
      entity_id: "binary_sensor.bathroom_humidity_trend"
      prob_given_true: 0.48
      prob_given_false: 0.093
      to_state: "on"
    - platform: "state"
      entity_id: "binary_sensor.bathroom_temperature_trend"
      prob_given_true: 0.48
      prob_given_false: 0.093
      to_state: "on"
    - platform: "state"
      entity_id: "binary_sensor.bathroom_multisensor_motion"
      prob_given_true: 0.50
      prob_given_false: 0.005
      to_state: "on"
    - platform: "template"
      value_template: "{{ now().timestamp() - states.binary_sensor.bathroom_multisensor_motion.last_changed.timestamp() < 180 | float }}"
      prob_given_true: 0.6
      prob_given_false: 0.01
    - platform: "state"
      entity_id: "input_boolean.bathroom_schedule"
      prob_given_true: 0.77
      prob_given_false: 0.143
      to_state: "on"

# Bedroom
- platform: bayesian
  name: "Bedroom Occupied"
  prior: 0.46
  probability_threshold: 0.8
  observations:
    - platform: "state"
      entity_id: "binary_sensor.bedroom_trisensor_motion"
      prob_given_true: 0.09
      prob_given_false: 0.008
      to_state: "on"
    - platform: "state"
      entity_id: "sensor.seb_phone_ble_room_presence"
      prob_given_true: 0.83
      prob_given_false: 0.115
      to_state: "Bedroom"
    - platform: "state"
      entity_id: "sensor.laura_phone_ble_room_presence"
      prob_given_true: 0.87
      prob_given_false: 0.115
      to_state: "Bedroom"
    - platform: "state"
      entity_id: "binary_sensor.in_bed"
      prob_given_true: 0.81
      prob_given_false: 0.007
      to_state: "Bedroom"

- platform: bayesian
  name: "In Bed"
  prior: 0.42
  probability_threshold: 0.9
  observations:
    - platform: "state"
      entity_id: "binary_sensor.bedroom_trisensor_motion"
      prob_given_true: 0.1
      prob_given_false: 0.023
      to_state: "on"
    - platform: "state"
      entity_id: "input_boolean.sleep_schedule"
      prob_given_true: 0.84
      prob_given_false: 0.185
      to_state: "on"
    - platform: "state"
      entity_id: "sensor.Laura_phone_ble_room_presence"
      prob_given_true: 0.86
      prob_given_false: 0.071
      to_state: "Bedroom"
    - platform: "state"
      entity_id: "sensor.seb_phone_ble_room_presence"
      prob_given_true: 0.86
      prob_given_false: 0.071
      to_state: "Bedroom"
    - platform: "state"
      entity_id: "binary_sensor.seb_sleeping"
      prob_given_true: 0.72
      prob_given_false: 0.071
      to_state: "on"
    - platform: "state"
      entity_id: "binary_sensor.laura_sleeping"
      prob_given_true: 0.72
      prob_given_false: 0.071
      to_state: "on"
    - platform: "state"
      entity_id: "sun.sun"
      prob_given_true: 0.89
      prob_given_false: 0.214
      to_state: "below_horizon"

# Entrance
- platform: bayesian
  name: "Entrance Occupied"
  prior: 0.5
  probability_threshold: 0.7
  observations:
    - platform: "state"
      entity_id: "binary_sensor.entrance_motion_camera"
      prob_given_true: 0.4
      prob_given_false: 0.2
      to_state: "on"
    - platform: "state"
      entity_id: "binary_sensor.front_door_motion"
      prob_given_true: 0.4
      prob_given_false: 0.2
      to_state: "on"

# Hall
- platform: bayesian
  name: "Hall Occupied"
  prior: 0.5
  probability_threshold: 0.7
  observations:
    - platform: "state"
      entity_id: "binary_sensor.hall_motion_camera"
      prob_given_true: 0.8
      prob_given_false: 0.2
      to_state: "on"
    - platform: "state"
      entity_id: "binary_sensor.hall_trisensor_motion"
      prob_given_true: 0.99
      prob_given_false: 0.4
      to_state: "on"

# Kitchen
- platform: bayesian
  name: "Kitchen Occupied"
  prior: 0.5
  probability_threshold: 0.7
  observations:
    - platform: "state"
      entity_id: "binary_sensor.kitchen_trisensor_motion"
      prob_given_true: 0.7
      prob_given_false: 0.3
      to_state: "on"

# Lounge
- platform: bayesian
  name: "Lounge Occupied"
  prior: 0.5
  probability_threshold: 0.7
  observations:
    - platform: "state"
      entity_id: "binary_sensor.lounge_motion_camera"
      prob_given_true: 0.75
      prob_given_false: 0.5
      to_state: "on"
    - platform: "state"
      entity_id: "binary_sensor.lounge_trisensor_motion"
      prob_given_true: 0.99
      prob_given_false: 0.5
      to_state: "on"
    - platform: "state"
      entity_id: "media_player.lounge_tv"
      prob_given_true: 0.8
      prob_given_false: 0.5
      to_state: "playing"
    - platform: "state"
      entity_id: "binary_sensor.lounge_motion_camera_tapo"
      prob_given_true: 0.7
      prob_given_false: 0.2
      to_state: "on"

# Study
- platform: bayesian
  name: "Study Occupied"
  prior: 0.42
  probability_threshold: 0.8
  observations:
    - platform: "state"
      entity_id: "binary_sensor.study_trisensor_motion"
      prob_given_true: 0.6
      prob_given_false: 0.07
      to_state: "on"
    - platform: "state"
      entity_id: "binary_sensor.seb_pc_active"
      prob_given_true: 0.9
      prob_given_false: 0.07
      to_state: "on"

# Toilet
- platform: bayesian
  name: "Toilet Occupied"
  prior: 0.5
  probability_threshold: 0.7
  observations:
    - platform: "state"
      entity_id: "binary_sensor.toilet_trisensor_motion"
      prob_given_true: 1
      prob_given_false: 0.2
      to_state: "on"

